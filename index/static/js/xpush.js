
/* @file xpush.js
 * @date 2017.12.19 15:46:01 
 */
(function($){var serveraddr="";var xpushName="NEWIM";var xpushthirdpush=$.flashserver.xpushthirdpush;var xpushpolltimeout=parseInt($.flashserver.xpushpolltimeout||"15",10)||15;var usehttps=$.flashserver.usehttps==1||$.protocol==="https:";var port=8088;var ssl=false;var _urlExp=/(wss?:)\/\/(.*?):(\d+)\/(\w+)/gi;$.xpush=function(){};$.xpush.debug=false;function getXpushAddr(){var mqttArr=$.flashserver.xpushim.split(";");var url="";for(var i=0;i<mqttArr.length;i++){if(usehttps){if(mqttArr[i].indexOf("wss")>-1){url=mqttArr[i];break}}else{if(mqttArr[i].indexOf("ws")>-1){url=mqttArr[i];break}}}math=_urlExp.exec(url);if(!math||!math.length){math=url.replace(/(wss?|tcp):\/\//gi,",$1,").replace(/:(\d+)/gi,",$1").replace(/\//gi,",").split(",")}ssl=math[1]==="wss:";serveraddr=math[2];port=Number(math[3]);xpushName=math[4]||"NEWIM"}var mqttMessage=function(data,topic,qos){var str=stringify(data);var message=new $.MQTT.Message(str);message.destinationName=topic;message.qos=qos;return message};var stringify=function(o){if(window.JSON){return JSON.stringify(o)}else{return $.JSON.toJSONString(o)}};var parse=function(s){if(window.JSON){try{return JSON.parse(s)}catch(e){try{return $.JSON.parseJSON(s)}catch(e){return{}}}}else{return $.JSON.parseJSON(s)}};var log=function(s){if($.xpush.debug){if(window.console&&console.log){console.log(s)}else{$.Log(s,1)}}};var formatXpushData=function(xpushdata){var formatData={};if(xpushdata){xpushdata=parse(xpushdata)}if(xpushdata.contents&&xpushdata.numbers){for(var key in xpushdata.contents){formatData[key]={unreadMessageCount:xpushdata.numbers[key],lastMessage:xpushdata.contents[key][0]}}}return formatData};$.xpushcallback=function(data){if(data){$.xpush.unreadMessageInfo=formatXpushData(data)}log(stringify($.xpush.unreadMessageInfo));if($.global.callbacks.ReceiveOfflineMessage){try{$.global.callbacks.ReceiveOfflineMessage($.xpush.unreadMessageInfo)}catch(e){log("客户尚未实现ReceiveOfflineMessage接口，或实现内部报错");$.xpush.UI.show($.xpush.unreadMessageInfo)}}else{$.xpush.UI.show($.xpush.unreadMessageInfo)}};$.xpush.startXpush=function(){var self=this;var callback=function(){$.xpushcallback(parse(xdr.responseText).message)};var search=function(){xdr=new XDomainRequest;if(xdr){xdr.onload=callback;xdr.onerror=callback;xdr.open("get",$.protocolFilter($.flashserver.xpushthirdpush+"/poll?userid="+NTKF.user.id+"&clientid="+self.clientid+"&devicetype=webhttp&ts="+(new Date).getTime()))}xdr.send()};requestXpushInterval=setInterval(search,xpushpolltimeout*1e3);search()};$.xpush.stopXpush=function(){clearInterval(requestXpushInterval);requestXpushInterval=null};$.xpush.init=function(){try{getXpushAddr()}catch(e){return}var self=this;var clientid="JS_"+$.randomChar(20).toLowerCase();this.clearSettingUnReadMsgCount=function(settingid){var info=self.unreadMessageInfo;if(info&&info[settingid]){info[settingid].unreadMessageCount=0;info[settingid].lastMessage="";if($.browser.oldmsie){xdr=new XDomainRequest;if(xdr){xdr.open("get",$.protocolFilter($.flashserver.xpushthirdpush+"/badge?userid="+NTKF.user.id+"&settingid="+settingid+"&ts="+(new Date).getTime()))}xdr.send();self.stopXpush()}else{self.connect.send(new mqttMessage({method:"clearSettingUnReadMsgCount",params:[,$.user.id,settingid]},self.peertopic,1))}$.xpushcallback()}};$.xpush.UI.init();if($.browser.oldmsie||!$.browser.supportMqtt){this.clientid=clientid;this.startXpush();return}this.connect=new $.MQTT.Client(serveraddr,port,clientid);this.connect.onConnectionLost=function(response){log(stringify(response))};this.connect.onMessageArrived=function(message){var data=parse(message.payloadString);if(data.method==="responseServer"){log("接收到xpush的responseServer");log("peertopic: "+data.params[0]);log("mywilltopic: "+data.params[1]);log("myapptopic: "+data.params[2]);self.peertopic=data.params[0];self.connect.subscribe(data.params[1],{onSuccess:function(){log("成功订阅xpush业务层遗言topic")},onFailure:function(){}});self.connect.subscribe(data.params[2],{onSuccess:function(){log("成功订阅xpush业务层接收消息topic");log("发送roomConnect");self.connect.send(new mqttMessage({method:"roomConnect",params:[$.user.id,clientid,0,0,"webmqtt"]},self.peertopic))},onFailure:function(){}});setInterval(function(){self.connect.send(new mqttMessage({method:"remoteKeepAlive",params:[clientid,$.user.id]},self.peertopic,0));log("发送KeepAlive")},3*60*1e3)}else if(data.method==="LoginResult"){log("接收到登录结果消息："+data.params[0]);if(data.params[4]===""){log("没有离线消息")}else{$.xpushcallback(data.params[4])}}else if(data.method==="remoteNotifyUnReadMessage"){$.xpushcallback(data.params[1])}};var willMessage=new mqttMessage({},"S/WILL/a",1);var options={userName:"ntguest",password:"xiaoneng123",useSSL:ssl,timeout:6,keepAliveInterval:180,cleanSession:false,willMessage:willMessage,mqttVersion:4,onSuccess:function(){log("连接MQTT服务成功");self.connect.subscribe("C/"+clientid,{onSuccess:function(result){log("订阅业务层成功");self.connect.send(new mqttMessage({method:"requestServer",params:[$.user.id,clientid,$.global.settingid,"",""]},"S/ROUTE/"+xpushName,0))},onFailure:function(error){log("订阅业务层失败")}})},onFailure:function(e){log("连接MQTT服务失败")}};this.connect.connect(options)};$.xpush.UI={settingids:[],init:function(){var self=this;this.xpushContainer=$({tag:"div",className:"nTalk-xpush-container",style:$.STYLE_BODY+"width:300px;height:100px;position:fixed;right:0;bottom:0;display:none;"}).appendTo(true);this.xpushMessageWrapper=$({tag:"ul",className:"nTalk-xpush-message-wrapper",style:$.STYLE_BODY+"margin:30px 100px 0 0;max-width:230px;"}).appendTo(this.xpushContainer);this.xpushMessageCount=$({tag:"span",className:"nTalk-xpush-message-count",style:$.STYLE_BODY+"position:absolute;color:#4C97EA;top:8px;right:4px;width:22px;height:22px;text-align:center;line-height:22px;font-size:18px;z-index:100000001"}).appendTo(this.xpushContainer);this.xpushMessageCountBkg=$({tag:"img",src:$.sourceURI+"images/messageCountBkg.png",className:"nTalk-xpush-message-count-bkg",style:$.STYLE_NBODY+"float:right;position:absolute;left:210px;top:5px;z-index:100000000;cursor:pointer"}).appendTo(this.xpushContainer);this.xpushMessage=$({tag:"li",className:"nTalk-xpush-message",style:$.STYLE_BODY+'color: white;min-width:60px;position:absolute;bottom:45px;right:100px;font-family: "微软雅黑";font-size: 14px;background: #3786EB;border-radius: 5px;display: inline;float: right;padding-left: 6px;padding-right: 2px;font-weight: 100;padding-top: 7px;padding-bottom: 7px;word-break:break-all;list-style:none'}).appendTo(this.xpushMessageWrapper);this.xpushMessageAngel=$({tag:"div",className:"nTalk-xpush-message-angel",style:$.STYLE_BODY+" display: block;position: absolute;left: 170px;top: 2px;margin:30px;height:0px;width:0px;border-left:solid 5px #3786EB;border-top:solid 5px rgba(0,0,0,0); border-bottom:solid 5px rgba(0,0,0,0); "}).appendTo(this.xpushMessageWrapper);this.xpushMessageCountBkg.bind("click",function(){for(var i=0,l=self.settingids.length;i<l;i++){NTKF.im_openInPageChat(self.settingids[i])}setTimeout(function(){self.hide();self.settingids=[]},200)})},show:function(data){var count=0;var lastMessage="";for(var settingid in data){count+=data[settingid].unreadMessageCount;lastMessage=data[settingid].lastMessage;this.settingids.push(settingid)}if(count!=0){this.xpushContainer.display(1);this.xpushMessage.html(lastMessage);this.xpushMessageCount.html(count)}},hide:function(){this.xpushContainer.display(0)}}})(nTalk);